const defaultConfig={lang:"EN",abstract:!1,list_of_contents:!0,list_of_references:!0,list_of_figures:!0,list_of_tables:!0,list_of_source_codes:!0,list_of_abbreviations:!0},config=window.bibtexConfig?{...defaultConfig,...window.bibtexConfig}:defaultConfig,{lang:lang,abstract:abstract,list_of_contents:list_of_contents,list_of_references:list_of_references,list_of_figures:list_of_figures,list_of_tables:list_of_tables,list_of_source_codes:list_of_source_codes,list_of_abbreviations:list_of_abbreviations}=config;function decodeLaTeXUmlauts(e){return e?e=(e=(e=(e=(e=(e=(e=(e=(e=(e=e.replace(/\\\"{?([aouAOU])}?/g,((e,t)=>({a:"ä",o:"ö",u:"ü",A:"Ä",O:"Ö",U:"Ü"}[t]||t)))).replace(/\\\"{?s}?/g,"ß")).replace("\\ss{}","ß")).replace(/\\c\{([cCsS])\}/g,((e,t)=>({c:"ç",C:"Ç",s:"ş",S:"Ş"}[t]||t)))).replace(/\\~([nN])/g,((e,t)=>"n"===t?"ñ":"Ñ"))).replace(/\\([`']){?([aeiouAEIOU])}?/g,((e,t,n)=>({"`a":"à","'a":"á","`e":"è","'e":"é","`i":"ì","'i":"í","`o":"ò","'o":"ó","`u":"ù","'u":"ú"}[t+n]||n)))).replace(/\\ae/g,"æ").replace(/\\AE/g,"Æ").replace(/\\oe/g,"œ").replace(/\\OE/g,"Œ")).replace(/~/g," ")).replace(/---/g,"—").replace(/--/g,"–")).replace(/[{}]/g,""):e}function parseBibtex(e){const t={};let n=0;for(;;){const r=e.indexOf("@",n);if(-1===r)break;const o=e.slice(r+1).match(/^(\w+)\s*\{/);if(!o){n=r+1;continue}const i=o[1],s=e.indexOf("{",r+i.length+1);if(-1===s)break;const a=e.indexOf(",",s+1);if(-1===a)break;const c=e.slice(s+1,a).trim();let l=s+1,d=1;for(;l<e.length&&d>0;)l++,"{"===e[l]?d++:"}"===e[l]&&d--;if(0!==d)break;const u=e.slice(a+1,l).trim(),f={};let m=0;for(;m<u.length;){for(;m<u.length&&/\s|,/.test(u[m]);)m++;if(m>=u.length)break;let e=m;for(;m<u.length&&/[A-Za-z0-9_\-]/.test(u[m]);)m++;const t=u.slice(e,m).trim().toLowerCase();for(;m<u.length&&"="!==u[m];)m++;if("="!==u[m])break;for(m++;m<u.length&&/\s/.test(u[m]);)m++;if("{"===u[m]){let e=m,n=0;do{"{"===u[e]?n++:"}"===u[e]&&n--,e++}while(e<u.length&&n>0);const r=u.slice(m+1,e-1);f[t]=decodeLaTeXUmlauts(r.trim()),m=e}else if('"'===u[m]){let e=m+1;for(;e<u.length&&'"'!==u[e];)e++;f[t]=decodeLaTeXUmlauts(u.slice(m+1,e).trim()),m=e+1}else{let e=m;for(;e<u.length&&","!==u[e];)e++;f[t]=decodeLaTeXUmlauts(u.slice(m,e).trim()),m=e}}t[c]={type:i,key:c,fields:f},n=l+1}return t}function formatAuthors(e){if(!e)return"";const t=e.replace(/[{}]/g,"").replace(/\s+/g," ").trim().split(/\s+and\s+/i).map((e=>e.trim())).map((e=>{const t=e.indexOf(",");if(-1!==t){const n=e.slice(0,t).trim();return e.slice(t+1).trim()+" "+n}return e}));if("DE"===lang){if(1===t.length)return t[0];if(2===t.length)return t[0]+" und "+t[1];const e=t.pop();return t.join(", ")+", und "+e}{if(1===t.length)return t[0];if(2===t.length)return t[0]+" and "+t[1];const e=t.pop();return t.join(", ")+", and "+e}}function formatPages(e){if(!e)return"";const t=e.replace(/--/g,"–");return"DE"===lang?`S. ${t}`:`pp. ${t}`}function formatCitation(e,t){const n=e.fields||{},r=(e.type||"").toLowerCase(),o=formatAuthors(n.author);let i=n.title?decodeLaTeXUmlauts(n.title).trim():"";i=i.replace(/\s+$/,""),i.endsWith(".")||(i+=".");let s=n.url?`[Online]. Available: <a href="${n.url}">${n.url}</a>`:"";"DE"===lang&&(s=s.replace("Available","Verfügbar"));let a=o?`[${t}] ${o}, “${i}”`:`[${t}] “${i}”`;switch(r){case"article":n.journal&&(a+=` ${n.journal}`),n.volume&&(a+="DE"===lang?`, Band ${n.volume}`:`, vol. ${n.volume}`),n.number&&(a+="DE"===lang?`, Nr. ${n.number}`:`, no. ${n.number}`),n.pages&&(a+=`, ${formatPages(n.pages)}`),(n.month||n.year)&&(a+=`, ${[n.month,n.year].filter(Boolean).join(" ")}`);break;case"inproceedings":case"conference":n.booktitle&&(a+=` in ${n.booktitle}`),n.editor&&(a+="DE"===lang?`, Red. ${n.editor}`:`, Ed. ${n.editor}`),n.address&&(a+=`, ${n.address}`),n.pages&&(a+=`, ${formatPages(n.pages)}`),n.year&&(a+=`, ${n.year}`);break;case"book":a+=` ${n.publisher||""}`,n.edition&&(a+="DE"===lang?`, Ausg. ${n.edition}`:`, ${n.edition} ed.`),n.address&&(a+=`, ${n.address}`),n.year&&(a+=`, ${n.year}`);break;case"techreport":n.institution&&(a+=`, ${n.institution}`),n.number&&(a+="DE"===lang?`, Tech. Ber. ${n.number}`:`, Tech. Rep. ${n.number}`),n.year&&(a+=`, ${n.year}`);break;case"misc":case"online":n.howpublished&&(a+=` ${n.howpublished}`),n.note&&(a+=`, ${n.note}`),n.url&&(a+=`, ${s}`),n.year&&(a+=`, ${n.year}`),n.urldate&&(a+=`, ${"DE"===lang?"Abgerufen":"Accessed"}: ${n.urldate}`);break;default:n.journal?a+=` ${n.journal}`:n.booktitle&&(a+=` ${n.booktitle}`),n.publisher&&(a+=`, ${n.publisher}`),n.year&&(a+=`, ${n.year}`),n.url&&(a+=`, ${s}`)}return a.trim()}function updateHeaders(){const e={abstract:{de:"Zusammenfassung",en:"Abstract",elements:["abstract","abstract-text"]},contents:{de:"Inhaltsverzeichnis",en:"List of contents",elements:["contents","contents-list"]},references:{de:"Quellen",en:"References",elements:["references","references-list"]},figures:{de:"Abbildungsverzeichnis",en:"List of figures",elements:["figures","figures-list"]},tables:{de:"Tabellenverzeichnis",en:"List of tables",elements:["tables","tables-list"]},source_codes:{de:"Quellcodeverzeichnis",en:"List of source codes",elements:["source-codes","source-codes-list"]},abbreviations:{de:"Abkürzungsverzeichnis",en:"List of abbreviations",elements:["abbreviations","abbreviations-list"]}};for(const t in e){const n=e[t];if(void 0!==config[`list_of_${t}`]?config[`list_of_${t}`]:config[t]){const e=n.elements[0],t=document.getElementById(e);t&&(t.innerText="DE"===lang?n.de:n.en)}else n.elements.forEach((e=>{const t=document.getElementById(e);t&&t.remove()}))}}async function processCitations(){if(!list_of_references)return;let e="";try{const t=await fetch("bibtex.bib");if(!t.ok)throw new Error("bibtex.bib konnte nicht geladen werden: "+t.status);e=await t.text()}catch(e){return void console.error("Fehler beim Laden der bibtex-Datei:",e)}const t=parseBibtex(e),n=[];!function e(t){if(3===t.nodeType)n.push(t);else if(1===t.nodeType){const n=t.tagName;if(["SCRIPT","STYLE","CODE","PRE"].includes(n))return;if("references-list"===t.id)return;for(let n of t.childNodes)e(n)}}(document.body);const r=/\[cite:([^\]]+)\]/g;let o=1;const i={};n.forEach((e=>{const n=e.nodeValue.replace(r,((e,n)=>{if(n=n.trim(),t[n]){n in i||(i[n]=o++);return`<a href="#${n}">[${i[n]}]</a>`}return"[?]"}));if(n!==e.nodeValue){const t=document.createElement("span");t.innerHTML=n,e.parentNode.replaceChild(t,e)}}));const s=document.getElementById("references-list");if(!s)return void console.warn('Kein Element mit id="references-list" gefunden.');s.style.listStyle="none",s.style.paddingLeft="0";Object.keys(i).sort(((e,t)=>i[e]-i[t])).forEach((e=>{const n=t[e];if(!n)return;const r=document.createElement("li");r.id=e,r.style.marginBottom="0.6em",r.innerHTML=formatCitation(n,i[e]),s.appendChild(r)}))}async function processChapters(){const e=document.querySelectorAll(".chapters");if(0===e.length)return;let t=6;e.forEach((e=>{const n=parseInt(e.tagName.substring(1));n<t&&(t=n)}));let n=[0,0,0];const r=document.getElementById("contents-list");e.forEach((e=>{const o=parseInt(e.tagName.substring(1))-t;if(o<0||o>2)return;0===o?(n[0]++,n[1]=0,n[2]=0):1===o?(n[1]++,n[2]=0):2===o&&n[2]++;let i=n.slice(0,o+1).join(".");const s="chapter"+i;e.id=s,e.hasAttribute("data-name")||e.setAttribute("data-name",e.textContent.trim().toLowerCase().replace(/\s+/g,"-"));const a=["title","abstract","contents","references","figures","tables","source-codes","abbreviations"];if(a.includes(s)||a.includes(e.id)||(e.innerHTML=i+" "+e.innerHTML),r){let t=document.createElement("li");t.style.marginLeft=20*o+"px",t.innerHTML=`<a href="#${s}">${e.innerText}</a>`,r.appendChild(t)}}));const o=document.querySelectorAll(".chapters");var i={};o.forEach((e=>{i[e.getAttribute("data-name")]=`<a href="#${e.id}" title="${e.innerText}">${"DE"===lang?"Kapitel":"chapter"} ${e.id.replace("chapter","")}</a>`}));const s=[];!function e(t){if(3===t.nodeType)s.push(t);else if(1===t.nodeType){if(["SCRIPT","STYLE"].includes(t.tagName))return;for(let n of t.childNodes)e(n)}}(document.body);const a=/\[ch:([^\]]+)\]/g;s.forEach((e=>{const t=e.nodeValue.replace(a,(e=>{const t=e.slice(1,-1);return i[t]?i[t]:"[?]"}));if(t!==e.nodeValue){const n=document.createElement("span");n.innerHTML=t,e.parentNode.replaceChild(n,e)}}))}async function processAbbreviations(){if(!list_of_abbreviations)return;let e={};try{const t=await fetch("abbreviations.json");t.ok?e=await t.json():console.warn("abbreviations.json nicht gefunden oder nicht lesbar. Fahre ohne JSON-Daten fort.")}catch(e){console.warn("Fehler beim Laden von abbreviations.json:",e)}const t=document.querySelectorAll("abbr"),n=new Map;t.forEach((t=>{let r,o,i=t.textContent.trim();if(e[i]?(r=i,o=e[i]):Object.values(e).includes(i)?(r=Object.keys(e).find((t=>e[t]===i)),o=i):(r=i,o=i),t.setAttribute("title",o),!t.parentElement||"A"!==t.parentElement.tagName||null===t.parentElement.getAttribute("href")){const e=document.createElement("a");e.href="#abbr:"+r.toLowerCase(),t.parentNode.replaceChild(e,t),e.appendChild(t)}n.has(r)||n.set(r,o)}));const r=document.getElementById("abbreviations-list");if(!r)return;r.innerHTML="";Array.from(n.entries()).sort(((e,t)=>e[0].localeCompare(t[0]))).forEach((([e,t])=>{let n=document.createElement("li"),o=document.createElement("strong");o.id="abbr:"+e.toLowerCase(),o.textContent=e;let i=document.createElement("dfn");i.textContent=t,n.appendChild(o),n.appendChild(document.createTextNode(" ")),n.appendChild(i),r.appendChild(n)}))}async function processFigures(){if(!list_of_figures)return;const e=document.querySelectorAll("figure.figures");if(0===e.length)return;const t=document.getElementById("figures-list");let n=0;e.forEach((e=>{n++;const r=("DE"===lang?"Abbildung":"Figure")+" "+n,o=e.querySelector("figcaption");if(o){const t=o.innerHTML;o.innerHTML=`${r}: ${t}`,e.id=e.id||`fig:auto-${n}`}if(t&&o){let n=document.createElement("li");n.innerHTML=`<a href="#${e.id}">${o.innerText}</a>`,t.appendChild(n)}}));const r=[];!function e(t){if(3===t.nodeType)r.push(t);else if(1===t.nodeType){if(["SCRIPT","STYLE"].includes(t.tagName))return;for(let n of t.childNodes)e(n)}}(document.body);const o=/\[fig:([^\]]+)\]/g;r.forEach((t=>{const n=t.nodeValue.replace(o,((t,n)=>{const r=document.getElementById("fig:"+n);if(!r)return"[?]";const o=Array.from(e).indexOf(r);if(-1===o)return"[?]";const i=("DE"===lang?"Abbildung":"Figure")+" "+(o+1);return`<a href="#${r.id}">${i}</a>`}));if(n!==t.nodeValue){const e=document.createElement("span");e.innerHTML=n,t.parentNode.replaceChild(e,t)}}))}async function processTables(){if(!list_of_tables)return;const e=document.querySelectorAll("table.tables");if(0===e.length)return;const t=document.getElementById("tables-list");let n=0;e.forEach((e=>{n++;const r=e.querySelector("caption .caption");if(!r)return;const o=r.innerHTML,i=("DE"===lang?"Tabelle ":"Table ")+n+": ";if(r.innerHTML=i+o,e.id=e.id||`tbl:auto-${n}`,t){const n=document.createElement("li");n.innerHTML=`<a href="#${e.id}">${r.innerText}</a>`,t.appendChild(n)}}));const r=[];!function e(t){if(3===t.nodeType)r.push(t);else if(1===t.nodeType){if(["SCRIPT","STYLE"].includes(t.tagName))return;for(let n of t.childNodes)e(n)}}(document.body);const o=/\[tbl:([^\]]+)\]/g;r.forEach((e=>{const t=e.nodeValue.replace(o,((e,t)=>{const n=document.getElementById("tbl:"+t);if(!n)return"[?]";const r=n.querySelector("caption .caption");if(!r)return"[?]";const o=r.innerText.split(":")[0].replace(/\D/g,"").trim(),i="DE"===lang?"Tabelle ":"Table ";return`<a href="#${n.id}">${i}${o}</a>`}));if(t!==e.nodeValue){const n=document.createElement("span");n.innerHTML=t,e.parentNode.replaceChild(n,e)}}))}async function processSourceCodes(){if(!list_of_source_codes)return;const e=document.querySelectorAll("figure.source-codes");if(0===e.length)return;const t=document.getElementById("source-codes-list");let n=0;e.forEach((e=>{n++;const r=e.querySelector("figcaption");if(!r)return;const o=r.innerHTML,i=("DE"===lang?"Quellcode ":"Source code ")+n+": ";if(r.innerHTML=i+o,e.id=e.id||`src:auto-${n}`,t){const n=document.createElement("li");n.innerHTML=`<a href="#${e.id}">${r.innerText}</a>`,t.appendChild(n)}}));const r=[];!function e(t){if(3===t.nodeType)r.push(t);else if(1===t.nodeType){if(["SCRIPT","STYLE"].includes(t.tagName))return;for(let n of t.childNodes)e(n)}}(document.body);const o=/\[src:([^\]]+)\]/g;r.forEach((e=>{const t=e.nodeValue.replace(o,((e,t)=>{const n=document.getElementById("src:"+t);if(!n)return"[?]";const r=n.querySelector("figcaption");if(!r)return"[?]";const o=r.innerText.split(":")[0].replace(/\D/g,"").trim(),i="DE"===lang?"Quellcode ":"Source code ";return`<a href="#${n.id}">${i}${o}</a>`}));if(t!==e.nodeValue){const n=document.createElement("span");n.innerHTML=t,e.parentNode.replaceChild(n,e)}}))}function initializeBibtexFormatter(){updateHeaders(),Promise.all([processCitations(),processChapters(),processAbbreviations(),processFigures(),processTables(),processSourceCodes()]).catch((e=>{console.error("Ein Fehler ist bei der Verarbeitung aufgetreten:",e)}))}document.addEventListener("DOMContentLoaded",initializeBibtexFormatter);
